
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="description" content="FileHub Premium is the leading secure file storage and sharing platform. Access high-quality resources, manage content efficiently, and enjoy seamless downloads with our AI-powered assistant.">
    <meta name="keywords" content="file storage, secure downloads, premium resources, cloud sharing, file manager, AI assistant, secure filehub, digital assets, ETC File, FileHub, File-Hubs, TG File, My file, source code, premium code, Monetag Bot, Earn Bot, giga.pub, Hyper Squad, Hyper 10 Squad">
    <meta name="robots" content="index, follow">
    <meta name="author" content="FileHub Team">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://file-hubs.vercel.app/">
    <meta property="og:title" content="FileHub Premium - Secure Storage & Sharing">
    <meta property="og:description" content="Access and manage your premium files with FileHub. Fast, secure, and powered by AI.">
    <meta property="og:image" content="https://iili.io/fY4mez7.jpg">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://file-hubs.vercel.app/">
    <meta property="twitter:title" content="FileHub Premium">
    <meta property="twitter:description" content="The ultimate platform for secure file management and premium downloads.">
    <meta property="twitter:image" content="https://iili.io/fY4mez7.jpg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <meta name="google-site-verification" content="bkC0hqaxdTEmhPnCqJthesPf0tTlu42qHmNRGauItew" />
    <link rel="icon" type="image/png" href="https://iili.io/fY4mez7.jpg">
    <link rel="apple-touch-icon" href="https://iili.io/fY4mez7.jpg">
    <link rel="manifest" href="/manifest.json">
    <title>Dashboard - FileHub</title>
    
    <script>
        (function() {
            try {
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
            } catch(e) {}
        })();
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4f46e5;
            --primary-soft: #e0e7ff;
            --primary-glow: rgba(79, 70, 229, 0.5);
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --nav-height: 60px;
            --unread-bg: #fee2e2;
            --unread-border: #fca5a5;
            --chat-user-bg: #4f46e5;
            --chat-user-text: #ffffff;
            --chat-ai-bg: #f1f5f9;
            --chat-ai-text: #0f172a;
            --skeleton-base: #e2e8f0;
            --skeleton-highlight: #f1f5f9;
        }

        [data-theme="dark"] {
            --primary: #818cf8;
            --primary-soft: #1e293b;
            --primary-glow: rgba(129, 140, 248, 0.5);
            --bg: #0f172a;
            --surface: #1e293b;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --border: #334155;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --unread-bg: #450a0a;
            --unread-border: #7f1d1d;
            --chat-user-bg: #818cf8;
            --chat-user-text: #0f172a;
            --chat-ai-bg: #334155;
            --chat-ai-text: #f8fafc;
            --skeleton-base: #1e293b;
            --skeleton-highlight: #334155;
        }

        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        body { 
            background: var(--bg); color: var(--text-main); font-family: 'Inter', sans-serif; 
            margin: 0; padding: 0; -webkit-font-smoothing: antialiased; 
            overflow-x: hidden; padding-bottom: calc(var(--nav-height) + 30px);
            transition: background 0.3s ease, color 0.3s ease;
            touch-action: pan-x pan-y;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, var(--skeleton-base) 25%, var(--skeleton-highlight) 50%, var(--skeleton-base) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
        }
        .sk-img { width: 100%; aspect-ratio: 16/9; border-radius: 12px; margin-bottom: 10px; }
        .sk-title { height: 20px; width: 80%; margin-bottom: 8px; }
        .sk-text { height: 14px; width: 60%; }
        .sk-avatar { width: 38px; height: 38px; border-radius: 50%; }
        .sk-row { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
        
        header { 
            background: var(--surface); border-bottom: 1px solid var(--border); 
            position: sticky; top: 0; z-index: 1000; height: 65px; display: flex; align-items: center;
        }
        .header-content { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 20px; position: relative; height: 100%; display: flex; align-items: center; }
        .header-main { width: 100%; display: flex; justify-content: space-between; align-items: center; }
        
        .brand { display: flex; align-items: center; gap: 10px; text-decoration: none; cursor: pointer; }
        .brand-img { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; border: 2px solid var(--surface); box-shadow: 0 0 0 2px var(--primary-soft); }
        .brand-text { font-family: 'Outfit', sans-serif; font-size: 1.3rem; font-weight: 700; color: var(--text-main); }

        .header-actions { display: flex; align-items: center; gap: 4px; }
        .icon-btn { background: transparent; border: none; padding: 8px; border-radius: 50%; color: var(--text-sub); display: flex; cursor: pointer; transition: 0.2s; align-items: center; justify-content: center; position: relative; }
        .icon-btn:hover { background: var(--bg); color: var(--text-main); }
        .icon-btn svg { width: 22px; height: 22px; }
        .ai-icon-img { width: 26px; height: 26px; border-radius: 50%; object-fit: contain; }
        
        .notif-badge {
            position: absolute; top: 5px; right: 5px;
            background: #ef4444; color: white;
            font-size: 0.65rem; font-weight: 700;
            width: 16px; height: 16px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--surface);
            display: none;
        }
        .notif-badge.active { display: flex; }

        .search-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--surface); display: flex; align-items: center; padding: 0 15px; transform: scaleX(0); transform-origin: right; transition: transform 0.3s; z-index: 10; box-sizing: border-box; }
        .search-overlay.active { transform: scaleX(1); }
        .search-box-wrapper { flex: 1; display: flex; align-items: center; height: 40px; border: 1.5px solid var(--border); border-radius: 50px; background: var(--bg); padding: 0 5px; }
        .search-input { flex: 1; border: none; background: transparent; padding: 0 5px; color: var(--text-main); outline: none; }
        .search-back-btn, .search-clear-btn { background: none; border: none; color: var(--text-sub); width: 35px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .search-clear-btn { visibility: hidden; } .search-clear-btn.visible { visibility: visible; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        .bottom-sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            opacity: 0; visibility: hidden; transition: 0.3s;
        }
        .bottom-sheet-overlay.active { opacity: 1; visibility: visible; }
        
        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: 80vh; max-height: 95vh;
            background: var(--surface);
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
            z-index: 2001;
            transform: translateY(100%); 
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), height 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column;
            will-change: transform, height;
        }
        .bottom-sheet.active { transform: translateY(0); }
        
        .bottom-sheet.expanded {
            height: 100% !important;
            max-height: 100% !important;
            border-radius: 0;
        }
        
        .sheet-header {
            padding: 15px 20px; border-bottom: 1px solid var(--border);
            display: grid; 
            grid-template-columns: 40px 1fr 40px;
            align-items: center;
            flex-shrink: 0;
        }
        
        .sheet-title { 
            font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 1.2rem; 
            text-align: center; justify-self: center;
        }
        
        .sheet-btn {
            background: none; border: none; cursor: pointer; color: var(--text-sub);
            padding: 5px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .sheet-btn:hover { background: var(--bg); color: var(--text-main); }
        .sheet-left-btn { visibility: visible; opacity: 1; }

        .sheet-body { flex: 1; overflow-y: auto; padding: 0; position: relative; display: flex; flex-direction: column; }

        .view-container { width: 100%; height: 100%; animation: fadeIn 0.3s ease; }
        .notif-list { list-style: none; padding: 0; margin: 0; }
        .notif-item {
            padding: 15px 20px; border-bottom: 1px solid var(--bg);
            cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; gap: 5px;
        }
        .notif-item:hover { background: var(--bg); }
        .notif-item.unread { background: var(--unread-bg); border-left: 4px solid var(--unread-border); }
        
        .notif-title-list {
            font-weight: 600; font-size: 0.95rem; color: var(--text-main);
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            line-height: 1.4; white-space: normal; word-break: break-word;
        }
        .notif-time { font-size: 0.75rem; color: var(--text-sub); margin-top: 4px; }

        .notif-detail-view { padding: 25px 20px; display: none; }
        .notif-detail-title {
            font-family: 'Outfit', sans-serif; font-size: 1.3rem; font-weight: 700;
            color: var(--text-main); margin-bottom: 8px; line-height: 1.3;
        }
        .notif-detail-time { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 20px; display: block; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .notif-detail-content { line-height: 1.6; color: var(--text-main); font-size: 0.95rem; }
        .notif-detail-content p { margin-bottom: 15px; }
        .notif-detail-content a { color: var(--primary); }

        .chat-container {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
            background: var(--bg);
            min-height: 0;
        }
        .chat-bubble {
            max-width: 80%; padding: 12px 16px; border-radius: 16px;
            font-size: 0.95rem; line-height: 1.5; position: relative;
            word-wrap: break-word; animation: fadeIn 0.2s ease;
        }
        .chat-bubble.user {
            align-self: flex-end; background: var(--chat-user-bg); color: var(--chat-user-text);
            border-bottom-right-radius: 2px;
        }
        .chat-bubble.ai {
            align-self: flex-start; background: var(--chat-ai-bg); color: var(--chat-ai-text);
            border-bottom-left-radius: 2px; display: flex; gap: 10px;
        }
        .ai-avatar {
            width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0;
            object-fit: contain; background: white; border: 1px solid var(--border);
        }
        .ai-content { flex: 1; overflow-x: hidden; }
        
        .chat-bubble pre { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; overflow-x: auto; }
        .chat-bubble code { font-family: monospace; font-size: 0.9em; }
        .chat-bubble.ai code { color: #d63384; background: rgba(0,0,0,0.05); padding: 2px 4px; border-radius: 4px; }
        .chat-bubble.ai pre code { color: inherit; background: transparent; padding: 0; }
        [data-theme="dark"] .chat-bubble.ai code { color: #f472b6; background: rgba(255,255,255,0.1); }
        
        .chat-footer {
            padding: 10px 15px; background: var(--surface); border-top: 1px solid var(--border);
            display: flex; align-items: flex-end; gap: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            flex-shrink: 0;
        }
        .chat-input {
            flex: 1; background: var(--bg); border: 1px solid var(--border);
            border-radius: 20px; padding: 10px 15px; max-height: 100px;
            overflow-y: auto; color: var(--text-main); font-family: inherit; font-size: 1rem;
            resize: none; outline: none; transition: border-color 0.2s;
        }
        .chat-input:focus { border-color: var(--primary); }
        .chat-send-btn {
            width: 42px; height: 42px; border-radius: 50%; background: var(--primary);
            color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; flex-shrink: 0;
        }
        .chat-send-btn:hover { opacity: 0.9; transform: scale(1.05); }
        .chat-send-btn svg { width: 20px; height: 20px; fill: white; margin-left: -2px; }

        .typing-container { display: flex; align-items: center; gap: 10px; margin-top: 10px; align-self: flex-start; }
        .ai-loading-img {
            width: 30px; height: 30px; border-radius: 50%; object-fit: contain;
            border: none;
            animation: spin 2s linear infinite;
        }
        .typing-dots { display: flex; gap: 4px; align-items: center; height: 30px; }
        .dot { width: 6px; height: 6px; background: var(--text-sub); border-radius: 50%; animation: wave 1.3s linear infinite; }
        .dot:nth-child(2) { animation-delay: -1.1s; }
        .dot:nth-child(3) { animation-delay: -0.9s; }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes wave { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }
        @keyframes fadeIn { from{opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);} }

        .carousel-wrap { width: 100%; aspect-ratio: 16/9; margin-bottom: 20px; border-radius: 16px; overflow: hidden; position: relative; box-shadow: var(--shadow-md); background: var(--surface); }
        .carousel-inner { display: flex; height: 100%; width: 100%; transition: transform 0.5s ease-out; }
        .slide { min-width: 100%; height: 100%; position: relative; cursor: pointer; }
        .slide img { width: 100%; height: 100%; object-fit: cover; }
        .carousel-dots { display: flex; justify-content: center; gap: 6px; margin-bottom: 25px; }
        .dot-c { width: 6px; height: 6px; background: var(--border); border-radius: 50%; transition: 0.3s; }
        .dot-c.active { background: var(--primary); width: 18px; border-radius: 3px; }

        .center-eye { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%) scale(0.8); 
            width: 50px; height: 50px; 
            display: flex; align-items: center; justify-content: center; 
            opacity: 0; transition: 0.3s; 
            color: white; 
        }
        .center-eye svg { width: 40px; height: 40px; stroke-width: 2.5; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        
        .slide:hover .center-eye { opacity: 1; transform: translate(-50%,-50%) scale(1); }
        .slide-overlay { position: absolute; bottom: 0; width: 100%; padding: 20px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); color: white; opacity: 0; transform: translateY(10px); transition: 0.3s; display: flex; justify-content: space-between; align-items: flex-end; box-sizing: border-box; }
        .slide:hover .slide-overlay { opacity: 1; transform: translateY(0); }
        .slide-title { font-family: 'Outfit', sans-serif; font-size: 1.1rem; margin-bottom: 5px; }
        
        .banner-pill {
            background: var(--primary-soft); color: var(--primary);
            padding: 4px 8px; border-radius: 6px;
            font-size: 0.75rem; font-weight: 700;
            display: flex; align-items: center; gap: 4px;
        }
        .banner-pill svg { width: 14px; height: 14px; stroke-width: 2.5; }

        .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; margin-top: 10px; }
        .section-header h2 { font-family: 'Outfit', sans-serif; font-size: 1.4rem; margin: 0; color: var(--text-main); }
        .section-icon { color: var(--primary); width: 24px; height: 24px; }

        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .file-card { background: var(--surface); border-radius: 12px; box-shadow: var(--shadow-sm); overflow: hidden; cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; border: 1px solid transparent; }
        .file-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: var(--shadow-md); }
        .card-thumb { width: 100%; aspect-ratio: 16/9; object-fit: cover; background: var(--bg); transition: 0.4s; }
        .file-card:hover .card-thumb { transform: scale(1.05); }
        .card-body { padding: 15px; background: var(--surface); z-index: 1; display: flex; flex-direction: column; flex: 1; }
        .card-title { font-family: 'Outfit', sans-serif; font-weight: 600; font-size: 1rem; color: var(--text-main); margin-bottom: 8px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 2.8em; }
        
        .card-footer { 
            margin-top: auto; display: flex; justify-content: space-between; align-items: center;
            font-size: 0.8rem; color: var(--text-sub); padding-top: 12px; border-top: 1px solid var(--bg); 
        }

        .meta-pill {
            background: var(--primary-soft); color: var(--primary);
            padding: 4px 10px; border-radius: 6px;
            font-size: 0.75rem; font-weight: 600; text-transform: lowercase;
            display: flex; align-items: center; gap: 5px;
        }
        .meta-pill svg { width: 14px; height: 14px; stroke-width: 2.5; }

        .detail-wrapper { width: 100%; background: transparent; padding: 0; animation: fadeIn 0.3s ease; }
        .detail-header-block { margin: 20px 0; }
        .detail-title { font-family: 'Outfit', sans-serif; font-size: 1.4rem; color: var(--text-main); line-height: 1.3; margin: 0 0 15px 0; }
        
        .detail-meta-grid { 
            display: grid; grid-template-columns: 1fr auto 1fr; 
            width: 100%; align-items: center; gap: 10px; margin-bottom: 10px;
        }
        .meta-left { justify-self: start; }
        .meta-center { justify-self: center; }
        .meta-right { justify-self: end; }

        .detail-desc { margin-top: 25px; line-height: 1.8; color: var(--text-main); font-size: 1rem; }
        .detail-desc p { margin-bottom: 15px; }
        .unlock-inline { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border); }
        
        .unlock-actions {
            display: flex; gap: 10px; align-items: stretch; width: 100%;
        }

        .unlock-btn { 
            flex: 1; background: var(--primary); color: white; border: none; 
            padding: 16px; border-radius: 12px; font-weight: 600; font-size: 1rem; 
            cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px;
            transition: 0.2s; box-shadow: 0 4px 12px var(--primary-glow);
            min-height: 54px; 
        }
        .unlock-btn:hover { transform: translateY(-2px); opacity: 0.95; }
        .unlock-btn:disabled { background: var(--text-sub); cursor: not-allowed; transform: none; box-shadow: none; }
        
        .copy-btn {
            background: var(--surface); color: var(--text-sub); border: 1px solid var(--border);
            border-radius: 12px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            flex-shrink: 0; transition: 0.2s;
            height: auto; 
            min-width: 100px;
            width: auto;
        }
        .copy-btn:hover { background: var(--bg); color: var(--text-main); border-color: var(--primary); }
        .copy-btn svg { width: 28px; height: 28px; }

        .lightbox-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px);
            z-index: 2005; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .lightbox-overlay.active { opacity: 1; }
        .lightbox-img {
            max-width: 95%; max-height: 80vh; border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.9); transition: transform 0.3s ease;
            object-fit: contain;
        }
        .lightbox-overlay.active .lightbox-img { transform: scale(1); }
        .lightbox-close {
            position: absolute; top: 0; right: 0;
            width: 48px; height: 65px; margin-right: 15px;
            display: flex; justify-content: center; align-items: center;
            background: none; border: none; color: white;
            cursor: pointer; z-index: 2006;
        }
        .lightbox-close svg { width: 30px; height: 30px; stroke-width: 2.5; }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: var(--surface); border-top: 1px solid var(--border);
            display: grid; grid-template-columns: 1fr auto 1fr;
            align-items: center; z-index: 1001; 
            padding-bottom: env(safe-area-inset-bottom);
            box-sizing: content-box; box-shadow: none;
        }
        .nav-col { display: flex; justify-content: center; align-items: center; height: 100%; }
        .nav-item {
            background: none; border: none; cursor: pointer; color: var(--text-sub);
            padding: 10px; display: flex; flex-direction: column; align-items: center; transition: 0.3s;
        }
        .nav-item svg { width: 30px; height: 30px; stroke-width: 2; }
        .nav-item:hover { color: var(--text-main); }
        .nav-home-wrapper { position: relative; width: 60px; height: 100%; display: flex; justify-content: center; }
        .nav-home {
            position: absolute; top: -20px;
            width: 52px; height: 52px;
            background: var(--primary); color: white;
            border-radius: 50%; border: 5px solid var(--surface);
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 8px 20px var(--primary-glow);
            cursor: pointer; transition: 0.2s;
        }
        .nav-home svg { width: 28px; height: 28px; }
        .nav-home:active { transform: scale(0.95); }

        .theme-icon-svg { transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .theme-active .theme-icon-svg { transform: rotate(180deg); }
        
        .error-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 50px 20px; text-align: center;
        }
        .error-icon { width: 100px; height: 100px; color: var(--text-sub); margin-bottom: 20px; }
        .error-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; color: var(--text-main); }
        .error-btn {
            margin-top: 20px; padding: 10px 20px; background: var(--primary); color: white;
            border-radius: 8px; border: none; font-weight: 600; cursor: pointer;
        }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <div class="header-main" id="headerMain">
            <div class="brand" onclick="navigateTo('/')">
                <img src="https://iili.io/fY4mez7.jpg" alt="Profile" class="brand-img" onerror="this.onerror=null;this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='">
                <span class="brand-text">FileHub</span>
            </div>
            <div class="header-actions">
                <button class="icon-btn" id="aiBtn"><img src="https://iili.io/fYWPezx.jpg" alt="AI" class="ai-icon-img" id="headerAiIcon" onerror="this.onerror=null;this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='"></button>
                
                <button class="icon-btn" id="notifBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                    <span class="notif-badge" id="notifBadge">0</span>
                </button>

                <button class="icon-btn" id="themeToggle">
                    <svg class="theme-icon-svg" id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <button class="icon-btn" id="searchTrigger"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></button>
            </div>
        </div>
        <div class="search-overlay" id="searchOverlay">
            <div class="search-box-wrapper">
                <button class="search-back-btn" id="searchBack"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></button>
                <input type="text" id="searchInput" class="search-input" placeholder="Search...">
                <button class="search-clear-btn" id="searchClear"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
        </div>
    </div>
</header>

<div class="container" id="app"></div>

<div class="bottom-sheet-overlay" id="sheetOverlay"></div>
<div class="bottom-sheet" id="notifSheet">
    <div class="sheet-header">
        <button class="sheet-btn sheet-left-btn" id="notifLeftBtn"></button>
        <span class="sheet-title">Notifications</span>
        <button class="sheet-btn" id="closeSheet">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
    </div>
    <div class="sheet-body">
        <div id="notifListView" class="view-container">
            <ul class="notif-list" id="notifList"></ul>
        </div>
        <div id="notifDetailView" class="view-container notif-detail-view">
            <div id="notifDetailContent"></div>
        </div>
    </div>
</div>

<div class="bottom-sheet" id="aiSheet">
    <div class="sheet-header">
        <button class="sheet-btn sheet-left-btn" id="aiExpandBtn"></button>
        <span class="sheet-title">Assistant</span>
        <button class="sheet-btn" id="closeAiSheet">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
    </div>
    <div class="chat-container" id="chatList"></div>
    <div class="chat-footer">
        <textarea id="chatInput" class="chat-input" placeholder="Message..." rows="1"></textarea>
        <button id="chatSendBtn" class="chat-send-btn">
            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
        </button>
    </div>
</div>

<div class="lightbox-overlay" id="lightbox">
    <button class="lightbox-close" id="lightboxClose">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
    <img src="" class="lightbox-img" id="lightboxImg">
</div>

<nav class="bottom-nav">
    <div class="nav-col">
        <button class="nav-item" title="Upload" onclick="navigateTo('/files/upload')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
        </button>
    </div>
    <div class="nav-home-wrapper">
        <button class="nav-home" title="Home" onclick="navigateTo('/')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        </button>
    </div>
    <div class="nav-col">
        <button class="nav-item" title="Account" onclick="navigateTo('/user/account')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        </button>
    </div>
</nav>

<script>
    const API = '/api';
    const HEADER = { 'X-Secure-Agent': 'FileHub-Client-v1', 'Content-Type': 'application/json' };

    // Firebase Configuration - START
    const firebaseConfig = {
      apiKey: "AIzaSyChHkWz0MLat5pWVu2P8h85O2zxr845hdk",
      authDomain: "file-hub-70ed5.firebaseapp.com",
      projectId: "file-hub-70ed5",
      storageBucket: "file-hub-70ed5.firebasestorage.app",
      messagingSenderId: "485294935637",
      appId: "1:485294935637:web:18727eb70d4ea84c814edc",
      measurementId: "G-S69PHS8L63"
    };
    // Firebase Configuration - END

    const userToken = localStorage.getItem('user_token');
    
    const HEAD_AI_LIGHT = "https://iili.io/fYWPezx.jpg";
    const HEAD_AI_DARK = "https://iili.io/fYWPEs2.jpg";
    const CHAT_AI_LIGHT = "https://iili.io/fYWPWg9.jpg";
    const CHAT_AI_DARK = "https://iili.io/fYWPSqB.jpg";

    const preloadImages = [HEAD_AI_LIGHT, HEAD_AI_DARK, CHAT_AI_LIGHT, CHAT_AI_DARK];
    preloadImages.forEach(src => {
        const img = new Image();
        img.src = src;
    });

    const authHeader = () => {
        return userToken ? { ...HEADER, 'Authorization': `Bearer ${userToken}` } : HEADER;
    };

    let bannerInterval, detailInterval;
    
    const app = document.getElementById('app');
    const searchTrigger = document.getElementById('searchTrigger');
    const searchOverlay = document.getElementById('searchOverlay');
    const searchBack = document.getElementById('searchBack');
    const searchInput = document.getElementById('searchInput');
    const searchClear = document.getElementById('searchClear');
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    
    const notifBtn = document.getElementById('notifBtn');
    const notifBadge = document.getElementById('notifBadge');
    const sheetOverlay = document.getElementById('sheetOverlay');
    const notifSheet = document.getElementById('notifSheet');
    const closeSheet = document.getElementById('closeSheet');
    const notifLeftBtn = document.getElementById('notifLeftBtn');
    const notifList = document.getElementById('notifList');
    const notifListView = document.getElementById('notifListView');
    const notifDetailView = document.getElementById('notifDetailView');
    const notifDetailContent = document.getElementById('notifDetailContent');

    const aiBtn = document.getElementById('aiBtn');
    const aiSheet = document.getElementById('aiSheet');
    const closeAiSheet = document.getElementById('closeAiSheet');
    const aiExpandBtn = document.getElementById('aiExpandBtn'); 
    const chatList = document.getElementById('chatList');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightboxImg');
    const lightboxClose = document.getElementById('lightboxClose');

    const SVG_EXPAND = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>';
    const SVG_COLLAPSE = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 14 10 14 10 20"></polyline><polyline points="20 10 14 10 14 4"></polyline><line x1="14" y1="10" x2="21" y2="3"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>';
    const SVG_BACK = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>';
    const SVG_CHECK = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
    const SVG_LINK = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>';

    let isNotifExpanded = false;
    let isAiExpanded = false;
    let isNotifInDetail = false;
    let allNotifications = [];

    function formatCount(n) {
        if (n >= 1000000) return (n / 1000000).toFixed(1).replace(/\.0$/, '') + 'm';
        if (n >= 1000) return (n / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
        return n;
    }

    function truncateExt(ext) {
        if (ext.length > 5) return ext.substring(0, 5) + '..';
        return ext;
    }

    function timeAgoShort(ts) {
        const seconds = Math.floor(Date.now() / 1000) - ts;
        if (seconds < 60) return "just now";
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}min ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}hr ago`;
        const days = Math.floor(hours / 24);
        if (days < 30) return `${days}day${days > 1 ? 's' : ''} ago`;
        const months = Math.floor(days / 30);
        if (months < 12) return `${months}month${months > 1 ? 's' : ''} ago`;
        return `1year+ ago`;
    }

    const getHomeSkeleton = () => {
        let html = '<div class="skeleton" style="width:100%; aspect-ratio:16/9; margin-bottom:20px;"></div>';
        html += '<div class="skeleton" style="width:50%; height:25px; margin-bottom:20px;"></div>';
        html += '<div class="file-grid">';
        for(let i=0; i<4; i++) {
            html += `
            <div style="background:var(--surface); border-radius:12px; padding:10px;">
                <div class="skeleton sk-img"></div>
                <div class="skeleton sk-title"></div>
                <div class="skeleton sk-text"></div>
            </div>`;
        }
        html += '</div>';
        return html;
    };

    const getDetailSkeleton = () => {
        return `
            <div class="skeleton" style="width:100%; aspect-ratio:16/9; margin-bottom:20px;"></div>
            <div class="skeleton" style="width:80%; height:30px; margin-bottom:15px;"></div>
            <div class="sk-row" style="justify-content:space-between">
                <div class="skeleton" style="width:80px; height:24px;"></div>
                <div class="skeleton" style="width:80px; height:24px;"></div>
                <div class="skeleton" style="width:80px; height:24px;"></div>
            </div>
            <div class="skeleton" style="width:100%; height:100px; margin-top:20px;"></div>
        `;
    };

    const getNotifSkeleton = () => {
        let html = '';
        for(let i=0; i<5; i++) {
            html += `
            <div style="padding:15px 20px; border-bottom:1px solid var(--bg)">
                <div class="skeleton" style="width:100%; height:16px; margin-bottom:8px;"></div>
                <div class="skeleton" style="width:40%; height:12px;"></div>
            </div>`;
        }
        return html;
    };

    const getChatSkeleton = () => {
        let html = '';
        for(let i=0; i<3; i++) {
             html += `
            <div style="padding:15px 20px; border-bottom:1px solid transparent">
                <div class="skeleton" style="width:100%; height:16px; margin-bottom:8px;"></div>
                <div class="skeleton" style="width:60%; height:12px;"></div>
            </div>`;
        }
        return html;
    };

    async function initTheme() {
        let mode = 'light';
        if (userToken) {
            try {
                const res = await fetch(`${API}/user/settings`, { headers: authHeader() });
                if (res.ok) {
                    const data = await res.json();
                    if(data.theme) mode = data.theme;
                }
            } catch(e) {}
        } else {
            mode = localStorage.getItem('theme') || 'light';
        }
        document.documentElement.setAttribute('data-theme', mode);
        updateThemeIcon(mode);
        updateThemeColor(mode);
        updateDynamicImages(mode);
    }

    function updateThemeIcon(mode) {
        if (mode === 'dark') themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
        else themeIcon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
    }

    function updateThemeColor(mode) {
        const color = mode === 'dark' ? '#1e293b' : '#ffffff';
        let meta = document.querySelector('meta[name="theme-color"]');
        if (meta) meta.setAttribute('content', color);
    }

    function getAiAvatarUrl(mode) {
        return mode === 'dark' ? CHAT_AI_DARK : CHAT_AI_LIGHT;
    }

    function updateDynamicImages(mode) {
        const headerIcon = document.getElementById('headerAiIcon');
        if (headerIcon) {
            headerIcon.src = mode === 'dark' ? HEAD_AI_DARK : HEAD_AI_LIGHT;
        }
        const chatAvatars = document.querySelectorAll('.ai-avatar');
        const avatarSrc = getAiAvatarUrl(mode);
        chatAvatars.forEach(img => img.src = avatarSrc);
        const spinner = document.querySelector('.ai-loading-img');
        if (spinner) {
            spinner.src = avatarSrc;
        }
    }

    themeToggle.addEventListener('click', async () => {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', next);
        
        updateThemeIcon(next);
        updateThemeColor(next);
        updateDynamicImages(next);

        themeToggle.classList.add('theme-active');
        setTimeout(() => themeToggle.classList.remove('theme-active'), 500);

        if (userToken) {
            await fetch(`${API}/user/update`, {
                method: 'POST',
                headers: authHeader(),
                body: JSON.stringify({ theme: next })
            });
        }
        localStorage.setItem('theme', next);
    });

    searchTrigger.addEventListener('click', () => { searchOverlay.classList.add('active'); searchInput.focus(); });
    searchBack.addEventListener('click', () => { 
        searchOverlay.classList.remove('active'); searchInput.value = ''; 
        if(searchInput.value.length === 0) searchClear.classList.remove('visible');
        if (window.location.pathname === '/') filterFiles('');
    });
    
    searchInput.addEventListener('input', (e) => {
        const term = e.target.value;
        if(term.length > 0) searchClear.classList.add('visible'); else searchClear.classList.remove('visible');
        if (window.location.pathname === '/') filterFiles(term);
    });

    searchInput.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
            const term = searchInput.value;
            searchInput.blur();
            searchOverlay.classList.remove('active'); 
            
            if (window.location.pathname !== '/') {
                window.location.href = '/?q=' + encodeURIComponent(term);
            } else {
                searchClear.classList.add('visible');
                searchOverlay.classList.remove('active'); 
                filterFiles(term);
            }
        }
    });

    searchClear.addEventListener('click', () => {
        searchInput.value = ''; searchInput.focus(); searchClear.classList.remove('visible');
        if (window.location.pathname === '/') filterFiles('');
    });

    function filterFiles(term) {
        term = term.toLowerCase();
        const cards = document.querySelectorAll('.file-card');
        if(cards.length === 0) return;
        
        cards.forEach(card => {
            const title = card.querySelector('.card-title').innerText.toLowerCase();
            card.style.display = title.includes(term) ? 'flex' : 'none';
        });
    }

    function updateNotifLeftIcon() {
        if (isNotifInDetail) {
            notifLeftBtn.innerHTML = SVG_BACK;
            notifLeftBtn.onclick = closeNotifDetail;
        } else {
            if (isNotifExpanded) {
                notifLeftBtn.innerHTML = SVG_COLLAPSE;
            } else {
                notifLeftBtn.innerHTML = SVG_EXPAND;
            }
            notifLeftBtn.onclick = toggleNotifExpand;
        }
    }

    function toggleNotifExpand() {
        isNotifExpanded = !isNotifExpanded;
        if (isNotifExpanded) {
            notifSheet.classList.add('expanded');
        } else {
            notifSheet.classList.remove('expanded');
        }
        updateNotifLeftIcon();
    }
    
    function updateAiLeftIcon() {
        if (isAiExpanded) {
            aiExpandBtn.innerHTML = SVG_COLLAPSE;
        } else {
            aiExpandBtn.innerHTML = SVG_EXPAND;
        }
    }

    function toggleAiExpand() {
        isAiExpanded = !isAiExpanded;
        if (isAiExpanded) {
            aiSheet.classList.add('expanded');
        } else {
            aiSheet.classList.remove('expanded');
        }
        updateAiLeftIcon();
    }
    
    aiExpandBtn.onclick = toggleAiExpand;

    async function loadNotifications() {
        if (!userToken) return;
        try {
            const res = await fetch(`${API}/user/notifications`, { headers: authHeader() });
            if (res.ok) {
                const data = await res.json();
                allNotifications = data.notifications || [];
                updateBadge();
            }
        } catch(e) {}
    }

    function updateBadge() {
        const unreadCount = allNotifications.filter(n => !n.is_read).length;
        notifBadge.innerText = unreadCount > 99 ? '99+' : unreadCount;
        if (unreadCount > 0) notifBadge.classList.add('active');
        else notifBadge.classList.remove('active');
    }

    function renderNotifications() {
        notifListView.style.display = 'block';
        notifDetailView.style.display = 'none';
        isNotifInDetail = false; 
        updateNotifLeftIcon();
        
        notifList.innerHTML = getNotifSkeleton();

        setTimeout(() => {
            if (allNotifications.length === 0) {
                notifList.innerHTML = '<li style="padding:40px;text-align:center;color:var(--text-sub)">No notifications yet.</li>';
                return;
            }
            
            notifList.innerHTML = allNotifications.map(n => {
                const isUnread = !n.is_read;
                return `
                <li class="notif-item ${isUnread ? 'unread' : ''}" onclick="openNotifDetail('${n.id}')">
                    <div class="notif-title-list">${n.title}</div>
                    <div class="notif-time">${timeAgoShort(n.created_at)}</div>
                </li>`;
            }).join('');
        }, 500);
    }

    window.openNotifDetail = async (nid) => {
        const notification = allNotifications.find(n => n.id === nid);
        if (!notification) return;

        notifListView.style.display = 'none';
        notifDetailView.style.display = 'block';
        
        isNotifInDetail = true;
        updateNotifLeftIcon();

        const descHtml = DOMPurify.sanitize(marked.parse(notification.decs));
        notifDetailContent.innerHTML = `
            <div class="notif-detail-title">${notification.title}</div>
            <div class="notif-detail-time">${timeAgoShort(notification.created_at)}</div>
            <div class="notif-detail-content markdown-body">${descHtml}</div>
        `;

        const el = document.querySelector(`.notif-item[onclick="openNotifDetail('${nid}')"]`);
        if (el && el.classList.contains('unread')) {
            el.classList.remove('unread');
            notification.is_read = true;
            updateBadge();
            try {
                await fetch(`${API}/user/notifications/read`, {
                    method: 'POST',
                    headers: authHeader(),
                    body: JSON.stringify({ notice_id: nid })
                });
            } catch(e) {}
        }
    };

    window.closeNotifDetail = () => {
        notifDetailView.style.display = 'none';
        notifListView.style.display = 'block';
        
        isNotifInDetail = false;
        updateNotifLeftIcon();
    };

    notifBtn.addEventListener('click', () => {
        if (!userToken) { alert("Please login to see notifications."); return; }
        renderNotifications();
        sheetOverlay.classList.add('active');
        notifSheet.classList.add('active');
    });
    
    function closeSheetCommon() {
        sheetOverlay.classList.remove('active');
        notifSheet.classList.remove('active');
        aiSheet.classList.remove('active');
        setTimeout(() => {
            isNotifExpanded = false;
            isAiExpanded = false;
            notifSheet.classList.remove('expanded');
            aiSheet.classList.remove('expanded');
            closeNotifDetail();
        }, 300);
    }
    
    closeSheet.addEventListener('click', closeSheetCommon);
    sheetOverlay.addEventListener('click', closeSheetCommon);
    
    chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        if(this.value === '') this.style.height = 'auto';
    });

    aiBtn.addEventListener('click', async () => {
        if (!userToken) { alert("Please login to use AI Assistant."); return; }
        sheetOverlay.classList.add('active');
        aiSheet.classList.add('active');
        
        updateAiLeftIcon();
        
        if(chatList.innerHTML.trim() === '') {
            loadChatHistory();
        }
    });

    closeAiSheet.addEventListener('click', closeSheetCommon);

    async function loadChatHistory() {
        chatList.innerHTML = getChatSkeleton();
        try {
            const res = await fetch(`${API}/ai/history`, { headers: authHeader() });
            if(res.ok) {
                const data = await res.json();
                chatList.innerHTML = '';
                if(data.chats && data.chats.length > 0) {
                    data.chats.forEach(msg => {
                        appendMessage(msg.role, msg.content, false);
                    });
                } else {
                    appendMessage('ai', 'Hello! How can I help you today?', false);
                }
                scrollToBottom();
            }
        } catch(e) {
            chatList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-sub)">Failed to load history.</div>';
        }
    }

    function appendMessage(role, text, isAnimating = true) {
        const div = document.createElement('div');
        div.className = `chat-bubble ${role}`;
        
        if (role === 'ai') {
            const parsed = DOMPurify.sanitize(marked.parse(text));
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const avatarUrl = getAiAvatarUrl(currentTheme);
            div.innerHTML = `
                <img src="${avatarUrl}" class="ai-avatar" onerror="this.onerror=null;this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='">
                <div class="ai-content markdown-body">${parsed}</div>
            `;
        } else {
            div.innerText = text; 
        }
        
        chatList.appendChild(div);
        if(isAnimating) scrollToBottom();
        if(role === 'ai') hljs.highlightAll();
    }

    function showTypingIndicator() {
        const div = document.createElement('div');
        div.className = 'typing-container';
        div.id = 'typingIndicator';
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const avatarUrl = getAiAvatarUrl(currentTheme);
        
        div.innerHTML = `
            <img src="${avatarUrl}" class="ai-loading-img" onerror="this.onerror=null;this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='">
            <div class="typing-dots">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
        `;
        chatList.appendChild(div);
        scrollToBottom();
    }

    function removeTypingIndicator() {
        const el = document.getElementById('typingIndicator');
        if(el) el.remove();
    }

    function scrollToBottom() {
        chatList.scrollTop = chatList.scrollHeight;
    }

    chatSendBtn.addEventListener('click', sendMessage);
    
    async function sendMessage() {
        const text = chatInput.value.trim();
        if(!text) return;
        
        chatInput.value = '';
        chatInput.style.height = 'auto';
        
        appendMessage('user', text);
        showTypingIndicator();
        
        try {
            const res = await fetch(`${API}/ai/chat`, {
                method: 'POST',
                headers: authHeader(),
                body: JSON.stringify({ prompt: text })
            });
            
            removeTypingIndicator();
            
            if (res.ok) {
                const data = await res.json();
                appendMessage('ai', data.reply);
            } else {
                appendMessage('ai', '**Error:** Failed to get response from AI.');
            }
        } catch (e) {
            removeTypingIndicator();
            appendMessage('ai', '**Error:** Connection failed.');
        }
    }


    window.openLightbox = (src) => {
        lightboxImg.src = src;
        lightbox.style.display = 'flex';
        requestAnimationFrame(() => {
            lightbox.classList.add('active');
        });
    };

    window.closeLightbox = () => {
        lightbox.classList.remove('active');
        setTimeout(() => {
            lightbox.style.display = 'none';
            lightboxImg.src = '';
        }, 300);
    };

    lightboxClose.addEventListener('click', window.closeLightbox);
    lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) window.closeLightbox();
    });

    window.navigateTo = (url) => {
        window.location.href = url;
    };

    function renderError(title, msg) {
        app.innerHTML = `
            <div class="error-container">
                <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <div class="error-title">${title}</div>
                <div style="color:var(--text-sub)">${msg}</div>
                <button class="error-btn" onclick="navigateTo('/')">Go Home</button>
            </div>
        `;
    }

    function router() {
        const path = window.location.pathname;
        clearInterval(bannerInterval);
        clearInterval(detailInterval);
        
        if (path === '/' || path === '/index.html') {
            renderHome();
        }
        else if (path.startsWith('/file/')) {
            const id = path.split('/file/')[1];
            if(id) renderDetail('files', id); else renderError('Page Not Found', 'The requested page could not be found.');
        }
        else if (path.startsWith('/banner/')) {
             const id = path.split('/banner/')[1];
             if(id) renderDetail('banners', id); else renderError('Page Not Found', 'The requested page could not be found.');
        }
        else if (path === '/files/upload') window.location.href = '/files/upload';
        else if (path === '/user/account') window.location.href = '/user/account';
        else {
             renderError('Page Not Found', 'The requested page could not be found.');
        }
    }

    async function renderHome() {
        document.title = "Dashboard - FileHub";
        
        app.innerHTML = getHomeSkeleton();
        try {
            const res = await fetch(`${API}/fetch-content`, { method: 'POST', headers: HEADER });
            const data = await res.json();
            
            let bannerHTML = '';
            if (data.banners.length > 0) {
                const dots = data.banners.map((_, i) => `<span class="dot-c ${i===0?'active':''}"></span>`).join('');
                bannerHTML = `
                <div class="carousel-wrap" id="homeCarousel">
                    <div class="carousel-inner" id="homeInner">
                        ${data.banners.map(b => `
                            <div class="slide" onclick="navigateTo('/banner/${b.id}')">
                                <img src="${b.thumbnail_url}" onerror="this.onerror=null;this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='">
                                <div class="center-eye">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                                </div>
                                <div class="slide-overlay">
                                    <span class="banner-pill">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                        ${truncateExt(b.file_extension)}
                                    </span>
                                    <div class="slide-title" style="flex:1; text-align:center; padding:0 5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${b.title}</div>
                                    <span class="banner-pill">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                        ${formatCount(b.total_downloads >= 0 ? b.total_downloads : 0)}
                                    </span>
                                </div>
                            </div>`).join('')}
                    </div>
                </div>
                <div class="carousel-dots" id="homeDots">${dots}</div>`;
            }

            let filesHTML = data.files.length ? data.files.map(f => `
                <div class="file-card">
                    <img src="${f.thumbnail_url || ''}" class="card-thumb" onerror="this.onerror=null;this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='" onclick="openLightbox(this.src); event.stopPropagation();">
                    <div class="card-body" onclick="navigateTo('/file/${f.id}')">
                        <div class="card-title">${f.title}</div>
                        <div class="card-footer">
                            <span class="meta-pill">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                ${truncateExt(f.file_extension)}
                            </span>
                            <span class="meta-pill">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                ${formatCount(f.total_downloads >= 0 ? f.total_downloads : 0)}
                            </span>
                        </div>
                    </div>
                </div>`).join('') : '<p style="text-align:center;color:var(--text-sub);grid-column:1/-1">No files found.</p>';

            app.innerHTML = `${bannerHTML}
                <div class="section-header">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M11 21h-1l1-7H7.5c-.58 0-.57-.32-.38-.66.19-.34.05-.08.07-.12C8.48 10.94 10.42 7.54 13 3h1l-1 7h3.5c.49 0 .56.33.47.51l-.07.15C12.96 17.55 11 21 11 21z"/></svg>
                    <h2>Latest Resources</h2>
                </div>
                <div class="file-grid">${filesHTML}</div>`;

            if(data.banners.length > 1) initCarousel('homeInner', 'homeDots', data.banners.length, true);

            const params = new URLSearchParams(window.location.search);
            const q = params.get('q');
            if (q) {
                searchInput.value = q;
                searchClear.classList.add('visible');
                filterFiles(q);
                window.history.replaceState({}, '', '/');
            }

        } catch (e) { app.innerHTML = '<div style="text-align:center;padding:50px;color:var(--text-sub)">Failed to load content.</div>'; }
    }

    function initCarousel(innerId, dotsId, count, isHome) {
        const inner = document.getElementById(innerId);
        const dots = document.getElementById(dotsId).children;
        let idx = 0;
        let interval;

        function update() {
            inner.style.transform = `translateX(-${idx * 100}%)`;
            for(let d of dots) d.classList.remove('active');
            dots[idx].classList.add('active');
        }
        function next() { idx = (idx + 1) % count; update(); }
        function prev() { idx = (idx - 1 + count) % count; update(); }
        
        function startTimer() {
             interval = setInterval(next, 5000);
             if(isHome) bannerInterval = interval; else detailInterval = interval;
        }

        startTimer();

        let touchStartX = 0;
        let touchEndX = 0;

        inner.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            clearInterval(interval);
        }, {passive: true});

        inner.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
            startTimer();
        }, {passive: true});

        function handleSwipe() {
            if (touchEndX < touchStartX - 50) next(); 
            if (touchEndX > touchStartX + 50) prev(); 
        }
    }

    async function renderDetail(type, id) {
        app.innerHTML = getDetailSkeleton();
        try {
            const res = await fetch(`${API}/detail/${type}/${id}`);
            if(!res.ok) {
                 renderError('Content Not Found', 'The file you are looking for does not exist or has been removed.');
                 return;
            }
            const item = await res.json();
            
            document.title = `${item.title} - FileHub`;

            let watched = 0;
            if (userToken) {
                const sRes = await fetch(`${API}/user/file-status/${item.id}`, { headers: authHeader() });
                const sData = await sRes.json();
                watched = sData.watched;
            } else {
                watched = parseInt(localStorage.getItem(`ad_${item.id}`) || '0');
            }

            let carouselHTML = '';
            if (item.detail_photos && item.detail_photos.length > 0) {
                const dots = item.detail_photos.map((_, i) => `<span class="dot-c ${i===0?'active':''}"></span>`).join('');
                carouselHTML = `
                <div class="carousel-wrap" id="detailWrap">
                    <div class="carousel-inner" id="detailInner">
                        ${item.detail_photos.map(u => `<div class="slide"><img src="${u}" onclick="openLightbox(this.src)" onerror="this.onerror=null;this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='"></div>`).join('')}
                    </div>
                </div>
                <div class="carousel-dots" id="detailDots">${dots}</div>`;
            } else if (item.thumbnail_url) {
                 carouselHTML = `<div class="carousel-wrap"><div class="slide"><img src="${item.thumbnail_url}" onclick="openLightbox(this.src)" onerror="this.onerror=null;this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='"></div></div>`;
            }

            const desc = DOMPurify.sanitize(marked.parse(item.description));
            
            app.innerHTML = `
                <div class="detail-wrapper">
                    ${carouselHTML}
                    <div class="detail-header-block">
                        <h1 class="detail-title">${item.title}</h1>
                        <div class="detail-meta-grid">
                            <span class="meta-pill meta-left">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                ${item.file_extension}
                            </span>
                            <span class="meta-pill meta-center">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                ${formatCount(item.total_downloads >= 0 ? item.total_downloads : 0)}
                            </span>
                            <span class="meta-pill meta-right">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                ${timeAgoShort(item.created_at)}
                            </span>
                        </div>
                    </div>
                    <div class="detail-desc markdown-body">${desc}</div>
                    <div id="unlockSection" class="unlock-inline"></div>
                </div>`;
            
            hljs.highlightAll();
            if (item.detail_photos && item.detail_photos.length > 1) {
                initCarousel('detailInner', 'detailDots', item.detail_photos.length, false);
            }

            renderUnlockLogic(type, item, watched);

        } catch(e) { renderError('Connection Error', 'Failed to load content. Please check your connection.'); }
    }

    function copyPageLink(btn) {
        const link = window.location.href || `https://file-hubs.vercel.app/`;
        navigator.clipboard.writeText(link).then(() => {
            const originalIcon = btn.innerHTML;
            btn.innerHTML = SVG_CHECK;
            btn.style.borderColor = '#10b981';
            btn.style.color = '#10b981';
            
            setTimeout(() => {
                btn.innerHTML = originalIcon;
                btn.style.borderColor = '';
                btn.style.color = '';
            }, 2500);
        });
    }

    function loadMonetag(zoneId) {
        return new Promise((resolve, reject) => {
            if (document.getElementById('monetag-script-' + zoneId)) {
                return resolve(); 
            }
            const script = document.createElement('script');
            script.id = 'monetag-script-' + zoneId;
            script.src = '//libtl.com/sdk.js';
            script.dataset.zone = zoneId;
            script.dataset.sdk = 'show_' + zoneId;
            script.onload = resolve;
            script.onerror = reject;
            document.body.appendChild(script);
        });
    }

    function renderUnlockLogic(type, item, watched) {
        const zone = document.getElementById('unlockSection');
        const req = item.required_ads;
        
        let mainBtnHtml = '';

        if (watched >= req) {
            mainBtnHtml = `
                <button class="unlock-btn" id="dlBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> 
                    Download Now
                </button>`;
        } else {
            let btnText = `Watch Ads: ${watched}/${req}`;
            if (watched > 0) btnText = `Unlock: ${watched}/${req}`;
            
            const icon = watched > 0 ? 
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>' : 
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';

            mainBtnHtml = `
                <button class="unlock-btn" onclick="triggerAd('${item.id}', ${watched}, ${req}, '${item.monitech_ad_id}', '${type}')">
                    ${icon} ${btnText}
                </button>`;
        }

        zone.innerHTML = `
            <div class="unlock-actions">
                ${mainBtnHtml}
                <button class="copy-btn" onclick="copyPageLink(this)" title="Copy Link">
                    ${SVG_LINK}
                </button>
            </div>
            <div id="dlStatus" style="text-align:center; margin-top:10px; font-size:0.85rem; color:var(--text-sub)"></div>`;

        const dlBtn = document.getElementById('dlBtn');
        if(dlBtn) {
            dlBtn.onclick = async function() {
                this.innerText = "Generating Link..."; this.disabled = true;
                try {
                    const res = await fetch(`${API}/reveal/${type}/${item.id}`, { method: 'POST', headers: authHeader() });
                    if (!res.ok) {
                        if(res.status === 403) throw new Error("Security check failed. Please watch ads.");
                        throw new Error("Error");
                    }
                    const d = await res.json();
                    if(d.download_url) window.location.href = d.download_url; else throw new Error();
                } catch (e) {
                    this.disabled = false; this.innerText = "Download Now";
                    document.getElementById('dlStatus').innerText = e.message || "Link generation failed.";
                }
            };
        }
    }

    window.triggerAd = async (fileId, currentWatched, reqAds, zoneId, type) => {
        const btn = document.querySelector('.unlock-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Loading Ad...';
        btn.disabled = true;

        try {
            if (!zoneId) throw new Error("Ad configuration missing");
            await loadMonetag(zoneId);

            const showFunction = window['show_' + zoneId];
            if (typeof showFunction !== 'function') {
                throw new Error("Ad SDK not ready");
            }

            await showFunction();

            const newWatchedCount = currentWatched + 1;

            if (userToken) {
                try {
                    await fetch(`${API}/user/track-ad`, {
                        method: 'POST',
                        headers: authHeader(),
                        body: JSON.stringify({ file_id: fileId })
                    });
                } catch(e) {}
            } else {
                localStorage.setItem(`ad_${fileId}`, newWatchedCount);
            }

            const mockItem = { 
                id: fileId, 
                required_ads: reqAds, 
                monitech_ad_id: zoneId 
            };
            
            renderUnlockLogic(type, mockItem, newWatchedCount);

        } catch(e) {
            btn.innerHTML = originalText;
            btn.disabled = false;
            document.getElementById('dlStatus').innerText = "Ad failed to load. Please disable adblocker or try again.";
        }
    };

    initTheme();
    loadNotifications();
    window.addEventListener('popstate', router);
    router();
</script>
</body>
</html>
